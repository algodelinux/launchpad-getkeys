#! /bin/bash
# launchpad-getkeys
# Rewrited version by Esteban M. Navas <algodelinux@gmail.com>
# Last update: 12/11/2025
#
# Parses the apt log, removes "GPG error:" lines, # extracts NO_PUBKEY and downloads missing keys,

RED='\033[0;31m'
GREEN='\033[0;32m'
WHITE='\033[1;37m'
CYAN='\033[36m'
NC='\033[0m' # No Color

UPDATE_LOG="/tmp/updateresults"
KEYRING_DIR="/etc/apt/trusted.gpg.d"
OLDKEYFILE="/etc/apt/trusted.gpg"
KEYPATHS="/usr/share/keyrings /etc/apt/keyrings /etc/apt/trusted.gpg.d"

function HELP () {
    echo -e "${WHITE}\nlaunchpad-getkeys${NC} is a utility to automatically import all missing GPG keys from repositories.\n"
    echo -e "Usage:"
    echo -e "   * No parameters: imports all missing GPG keys."
    echo -e "   * ${WHITE}-k SERVER:PORT${NC} specifies an alternative key server."
    echo -e "   * ${WHITE}-p PROXY:PORT${NC} uses an HTTP proxy."
    echo -e "   * ${WHITE}-r${NC} removes expired keys."
    echo -e "   * ${WHITE}-f${NC} forces an 'apt-get update'.\n"
    exit 0
}

function remove_expired_keys () {
    echo -e "${CYAN}Checking for expired keys...${NC}"
    if [ -f "$OLDKEYFILE" ]; then
        LC_ALL=C gpg --no-default-keyring --keyring="$OLDKEYFILE" --list-keys | grep -E 'pub.*expired' -A 1 > /tmp/expiredkeys
        if [ -s /tmp/expiredkeys ]; then
            for keyid in $(grep -E '[[:xdigit:]]{40}' /tmp/expiredkeys); do
                echo -e "${GREEN}Removing key $keyid from $OLDKEYFILE${NC}"
                gpg --no-default-keyring --keyring="$OLDKEYFILE" --batch --yes --delete-keys "$keyid"
            done
        fi
    fi

    for KEYPATH in $KEYPATHS; do
        if [ -d "$KEYPATH" ] && [ "$(ls -A "$KEYPATH")" ]; then
            for keyfile in $(find "$KEYPATH" -type f -not -name "*~"); do
                mimetype=$(file --mime "$keyfile")
                if [[ "$mimetype" == *"charset=binary"* ]]; then
                    LC_ALL=C gpg --no-default-keyring --keyring="$keyfile" --list-keys | grep -E 'pub.*expired' -A 1 > /tmp/expiredkeys
                    if [ -s /tmp/expiredkeys ]; then
                        for keyid in $(grep -E '[[:xdigit:]]{40}' /tmp/expiredkeys); do
                            echo -e "${GREEN}Removing key $keyid from $keyfile${NC}"
                            gpg --no-default-keyring --keyring="$keyfile" --batch --yes --delete-keys "$keyid"
                        done
                    fi
                else
                    echo -e "${CYAN}Removing ASCII key file $keyfile${NC}"
                    rm -f "$keyfile"
                fi
            done
        fi
    done
    rm -f /tmp/expiredkeys
}

function download_key_from_known_sources() {
    local keyid="$1"
    local target="$2"

    # For testing purposes only
    # echo -e "${CYAN}Trying to download key ${keyid} from known sources...${NC}"

    case "$keyid" in
        # Oracle VirtualBox
        A2F683C52980AECF)
            wget -qO- https://www.virtualbox.org/download/oracle_vbox_2016.asc | gpg --yes --output /usr/share/keyrings/oracle-virtualbox-2016.gpg --dearmor > /dev/null 2>&1
            ;;

        # Steven Pusser (Firefox / Thunderbird)
        0FAD31CA8719FCE4)
            wget -qO- "https://build.opensuse.org/projects/home:stevenpusser/signing_keys/download?kind=gpg" | gpg --yes --output /etc/apt/trusted.gpg.d/home_stevenpusser.gpg --dearmor > /dev/null 2>&1
            ;;

        # Waydroid
        0E406D181DCEE19C)
            wget -q --https-only --secure-protocol=TLSv1_2 -O /usr/share/keyrings/waydroid.gpg https://repo.waydro.id/waydroid.gpg
            ;;

        # Ookla (Speedtest)
        8E61C2AB9A6D1557)
            wget -qO- https://packagecloud.io/ookla/speedtest-cli/gpgkey | gpg --yes --output /usr/share/keyrings/ookla_speedtest-cli-archive-keyring.gpg --dearmor > /dev/null 2>&1
            ;;

        # NodeSource
        1655A0AB68576280)
            wget -qO- https://deb.nodesource.com/gpgkey/nodesource.gpg.key | gpg --yes --dearmor | tee /usr/share/keyrings/nodesource.gpg > /dev/null 2>&1
            ;;

        # HashiCorp
        AA16FCBCA621E701)
            wget -qO- https://apt.releases.hashicorp.com/gpg | gpg --yes --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null 2>&1
            ;;

        # Docker
        7EA0A9C3F273FCD8)
            wget -qO- https://download.docker.com/linux/ubuntu/gpg | gpg --yes --dearmor | tee /usr/share/keyrings/docker-archive-keyring.gpg > /dev/null 2>&1
            ;;

        # Netdata
        54832F89F09FED90)
            curl -fsSL https://packagecloud.io/netdata/netdata/gpgkey | gpg --yes --dearmor > /etc/apt/trusted.gpg.d/netdata_netdata.gpg
            ;;

        # Tailscale
        458CA832957F5868)
            local distro codename
            distro=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')
            codename=$(lsb_release -cs)
            wget -qO- "https://pkgs.tailscale.com/stable/${distro}/${codename}.noarmor.gpg" | tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null 2>&1
            ;;

        # Debian
        54404762BBB6E853|BDE6D2B9216EC7A8)
            wget -qO- https://ftp-master.debian.org/keys/archive-key-12.asc | gpg --yes --dearmor > /etc/apt/trusted.gpg.d/debian-archive-12.gpg
            wget -qO- https://ftp-master.debian.org/keys/archive-key-12-security.asc | gpg --yes --dearmor > /etc/apt/trusted.gpg.d/debian-security-12.gpg
            ;;
        # Unknown
        *)  return 1
            ;;
    esac
}

# Initial checks
if [[ $(whoami) != root ]]; then
    echo -e "${RED}Please run this script as root or using sudo.${NC}"
    exit 1
fi

REMOVE_EXPIRED_KEYS="no"

[ -s /etc/default/launchpad-getkeys ] && . /etc/default/launchpad-getkeys

while getopts "k:p:rhf\?" opt; do
    case "$opt" in
        k ) KEYSERVER="$OPTARG" ;;
        p ) PROXY="$OPTARG" ;;
        r ) REMOVE_EXPIRED_KEYS="yes" ;;
        f ) FORCE_UPDATE=1 ;;
        h | \? ) HELP ;;
    esac
done
shift $((OPTIND -1))

if [[ $SERVER ]] && [[ $PORT ]]; then
   ping -c 1 $SERVER >/dev/null 2>&1

   if [ $? -eq 0 ]; then
       PROXY=http://$SERVER:$PORT
   fi
fi

if [[ $KEYSERVER ]]; then
	KEYSERVERANDPORT=$(echo $KEYSERVER | grep ":")
	if [[ ! $KEYSERVERANDPORT ]]; then
	   echo -e "${RED}Error: please enter a keyserver and a port, like so: sudo launchpad-getkeys -k SERVER:PORT${NC}"
	   exit 0
	fi
fi

if [[ $PROXY ]]; then
	PROXYSERVERANDPORT=$(echo $PROXY | grep ":")
	if [[ ! $PROXYSERVERANDPORT ]]; then
	   echo -e "${RED}Error: please enter a proxyserver and a port, like so: sudo launchpad-getkeys -p http://PROXYSERVER:PORT${NC}"
	   exit 0
	fi
fi

PROXY_OPTS=()
if [[ ! -z ${PROXY:-} ]]; then
   PROXY_OPTS=( --keyserver-options http-proxy=$PROXY )
fi

KEYSRV_OPTS=( --keyserver hkp://keyserver.ubuntu.com:80 )
if [[ $KEYSERVER ]]; then
    KEYSRV_OPTS=( --keyserver hkp://$KEYSERVER )
fi

if [[ "$REMOVE_EXPIRED_KEYS" == "yes" ]]; then
    remove_expired_keys
fi

mkdir -p "$KEYRING_DIR"

# Remove previous automatic import files
OLD_FILES=( $(find "$KEYRING_DIR" -maxdepth 1 -type f -name 'launchpad-getkeys_imported____*') )
if [[ ${#OLD_FILES[@]} -gt 0 ]]; then
    echo -e "${CYAN}Deleting ${#OLD_FILES[@]} old 'launchpad-getkeys_imported____*' file(s)...${NC}"
    rm -f "${OLD_FILES[@]}"
fi

echo -e "${GREEN}\nRunning apt-get update to detect missing GPG keys...${NC}"
LC_ALL=C apt-get update 2> "$UPDATE_LOG"

# Parse log and download keys, grouping by repo and concatenating all its pubkeys
grep -i "error" "$UPDATE_LOG" | grep -A1 "NO_PUBKEY" | grep -Eo 'https?://[^ ]+|NO_PUBKEY[[:space:]]+[A-Za-z0-9:]+([[:space:]]|$)' |
awk '
    /^https?:\/\// { if (repo) print repo " " keys; repo=$0; keys=""; next }
    /NO_PUBKEY/ { sub(/^NO_PUBKEY[[:space:]]+/, "", $0); keys=keys" "$0 }
    END { if (repo) print repo " " keys }
' |
while read -r repo keys; do
    repo_clean="${repo#http://}"
    repo_clean="${repo_clean#https://}"
    repo_clean="${repo_clean//\//-}"
    repo_clean="${repo_clean%-InRelease}"
    current_repo="$KEYRING_DIR/$repo_clean.gpg"

    echo -e "${CYAN}==> Processing repository: ${repo}${NC}"
    echo -e "${CYAN}    Keys: ${keys}${NC}"

    for key in $keys; do
        echo -e "${CYAN}--> Fetching key ${key}${NC}"

        # Try known sources first
        if download_key_from_known_sources "$key" "$current_repo"; then
            echo -e "${GREEN}✔ Key ${key} obtained from known source${NC}"
            continue
        fi

        # Fallback to keyserver
        # For testing purposes only
        #echo -e "${CYAN}Trying to fetch ${key} from keyserver.ubuntu.com...${NC}"

        TMP_KEYRING="$(mktemp)"
        if gpg --ignore-time-conflict --no-options --no-default-keyring --no-auto-check-trustdb \
               --trust-model always --keyring "$TMP_KEYRING" "${KEYSRV_OPTS[@]}" "${PROXY_OPTS[@]}" \
               --recv-keys "$key" >/dev/null 2>&1; then

            # Append (concatenate) the key to the repo keyring
            gpg --ignore-time-conflict --no-options --no-default-keyring --no-auto-check-trustdb \
                --trust-model always --keyring "$TMP_KEYRING" --export "$key" | \
                gpg --yes --dearmor >> "$current_repo"
            echo -e "${GREEN}✔ Key ${key} added to ${current_repo}${NC}"
        else
            echo -e "${RED}✖ Failed to fetch key ${key}${NC}"
        fi
        rm -f "$TMP_KEYRING"
    done

    # Final validation: ensure file is valid GPG
    if [[ -s "$current_repo" && $(gpg --list-packets "$current_repo" >/dev/null 2>&1; echo $?) -eq 0 ]]; then
        echo -e "${GREEN}✔ All keys successfully saved in ${current_repo}${NC}"
    else
        echo -e "${RED}✖ Invalid keyring created for ${repo}${NC}"
        rm -f "$current_repo"
    fi
done | tee /var/log/launchpad-getkeys.log

echo -e "${GREEN}\nDone. Run 'sudo apt-get update' again to verify that no key errors remain.${NC}"
#rm -f "$UPDATE_LOG"
